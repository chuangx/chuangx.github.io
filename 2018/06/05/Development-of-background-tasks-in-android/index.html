<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>Evolving of android threading &amp; background tasks | Coffee Thoughts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/coffee.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
  
</head>
</html>
<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2018/06/05/Development-of-background-tasks-in-android/">Evolving of android threading & background tasks</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 05 2018</p>
  </section>

  <section class="article-entry">
    <p>è¿™ç¯‡æ–‡ç« ä¸»è¦å¤§è‡´è®²è§£åœ¨androidä¸Šå®ç°åå°ä»»åŠ¡çš„å‡ ç§æ–¹æ³•ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ä»¥åŠå¼€å‘ä¸­çš„æœ€ä½³å®è·µã€‚<br>åå°ä»»åŠ¡ (background tasks/operations) æ˜¯ä¸€ä¸ªå¾ˆå®½æ³›çš„æ¦‚å¿µï¼Œåœ¨androidä¸Šæˆ‘ä»¬é€šå¸¸æŒ‡éä¸»çº¿ç¨‹çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç½‘ç»œæ“ä½œï¼Œè¯»å†™æ•°æ®åº“ï¼æ–‡ä»¶æˆ–æ˜¯å®šæ—¶ä»»åŠ¡ç­‰ç­‰ï¼Œè¿™äº›ä»»åŠ¡é€šå¸¸è€—æ—¶è¾ƒä¹…å› è€Œéœ€è¦å¼‚æ­¥å¤„ç†ã€‚Androidç»™å¼€å‘è€…æä¾›äº†å¾ˆå¤šä¸åŒçš„apiæ¥åšè¿™ä»¶äº‹æƒ…ï¼Œæ¯”å¦‚AsyncTask, Loader, IntentService, JobIntentService, AlarmManager, JobDispatcher, JobScheduler, WorkManagerâ€¦ ahï¼Œé™¤äº†ä»¥ä¸Šè¿™äº›ï¼Œæˆ‘ä»¬è¿˜æœ‰rxjava (the list might keep growing) </p>
<a id="more"></a>
<p>AsyncTaskå‡ºç°åœ¨API 3ä¸­ï¼Œç›¸ä¿¡å¤§å®¶åœ¨androidå¼€å‘çš„åˆæœŸå°±å·²ç»æ¥è§¦è¿‡äº†ã€‚ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…æ˜¯AsyncTaskæœ€åˆè®¾è®¡æ˜¯åœ¨ä¸€ä¸ªåå°çº¿ç¨‹ä¸Šä¸²è¡Œæ‰§è¡Œæ‰€æœ‰çš„ä»»åŠ¡ï¼Œåœ¨API 4ä¸­ä¸ºäº†æå‡æ•ˆç‡å˜æˆäº†å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œ2å¹´ä¹‹ååœ¨android 3.0 (API 11) å› ä¸ºæœ‰å¤ªå¤šåº”ç”¨å¹¶å‘é”™è¯¯ä¸­åˆæ”¹å›äº†é»˜è®¤å•çº¿ç¨‹ä¸²è¡Œå¤„ç† :shrug<br>AsyncTaskçš„å‡ºç°æ˜¯ä¸ºäº†ç®€åŒ–androidä¸Šåå°çº¿ç¨‹å¤„ç†ä»¥åŠå’Œä¸»çº¿ç¨‹çš„é€šä¿¡ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒå¹¶ä¸èƒ½å¾ˆå¥½çš„å¤„ç† activity/fragment çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸€ä¸ªæˆ‘ä»¬ç»å¸¸é‡åˆ°çš„é—®é¢˜å°±æ˜¯ç”¨æˆ·æ—‹è½¬å±å¹•ä¹‹åï¼Œå½“å‰activityè¢«é‡æ–°åˆ›å»ºï¼Œä½†æ˜¯AsyncTaskä¼šç»§ç»­è¿è¡Œå¹¶æŒæœ‰å‰ä¸€ä¸ªactivityçš„referenceï¼Œè¿™æ ·ä¸ä»…å¯¼è‡´å‰ä¸€ä¸ªactivityæ²¡æœ‰åŠæ³•è¢«ç«‹åˆ»é”€æ¯ï¼Œè€Œä¸”onPostExecuteå¯¹UIçš„æ›´æ–°ä¼šæ²¡æœ‰æ•ˆæœå› ä¸ºå…¶å°è¯•æ›´æ–°çš„æ˜¯å‰ä¸€ä¸ªactivityã€‚<br>æ‰€ä»¥æˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹AsyncTaskåšé¢å¤–çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ¯”å¦‚åœ¨activity#onStopä¸­å»å–æ¶ˆæ‰€æœ‰è¿˜æ²¡æœ‰ç»“æŸçš„AsyncTaskï¼Œï¼ˆå½“ç„¶ä½ å¯ä»¥é€šè¿‡é˜»æ­¢activity/fragmentçš„æ–°å»ºå»è§£å†³è¿™ä¸ªé—®é¢˜, but itâ€™s really a terrible idea, think twice before doing anything like that)ã€‚éšä¹‹è€Œæ¥çš„å¦ä¸€ä¸ªå‘å°±æ˜¯AsyncTask#cancel is best effort, è€Œä¸”cancelå¹¶ä¸ä¼šç«‹åˆ» é˜»æ–­doInBackgroundçš„ä»»åŠ¡æ‰§è¡Œï¼Œ æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸æ–­æ£€æŸ¥isCancelled ç¡®ä¿ä»»åŠ¡å¯ä»¥å°½å¿«å–æ¶ˆæ‰ã€‚å¦‚æœä½ æƒ³è¦äº†è§£çš„æ›´å¤šAsyncTaskçš„é—®é¢˜ï¼ŒDan Lew çš„è¿™ç¯‡æ–‡ç« æœ‰æ›´æ·±å…¥çš„è®²è§£ã€‚<br><a href="http://blog.danlew.net/2014/06/21/the-hidden-pitfalls-of-asynctask/" target="_blank" rel="noopener">http://blog.danlew.net/2014/06/21/the-hidden-pitfalls-of-asynctask/</a><br>blog.danlew.net</p>
<p>AsyncTaskçš„è¿™äº›ç¼ºç‚¹ç¡®å®ç»™æˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤šboilerplate codeè€Œä¸”ä¸€ä¸å°å¿ƒå°±å®¹æ˜“å‡ºé”™ï¼Œæˆ‘ä¸€èˆ¬åªæœ‰åœ¨å¼‚æ­¥æ“ä½œæ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„æ—¶å€™ä¼šä½¿ç”¨AsyncTask:</p>
<ul>
<li>Simple and quick operations - to avoid blocking other possible async tasks as itâ€™s running in serial by default</li>
<li>No UI update involved - to avoid extra lifecycle management </li>
<li>Killable - the task can be killed/cancelled if necessary </li>
</ul>
<p>å¦‚æœæ˜¯æ»¡è¶³ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶çš„æ“ä½œçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨AsyncTask.execute(Runnable r) å°±å¯ä»¥äº†ï¼Œe.g. å¼‚æ­¥è·å–æ›´æ–°è®¾å¤‡çš„ad info AdvertisingIdClient.getAdvertisingIdInfo.</p>
<p>å…¶å®Loaderçš„å‡ºç°(API 11)æœ¬æ¥å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šé¢æåˆ°çš„AsyncTask lifecycleé—®é¢˜ï¼ŒAsyncTaskLoaderæ˜¯Loaderçš„ä¸€ä¸ªå®ç°ï¼Œä»åå­—ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºè®¾è®¡çš„åˆè¡·ã€‚ä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤šç¼ºé™·ä¸€ç›´è¢«å¼€å‘è€…æŠ±æ€¨ï¼Œconfusing api, testability and boilerplate code, etc. åœ¨API 28ä¸­ï¼ŒLoaderå·²è¢«å®˜æ–¹deprecatedï¼Œæ¨èä½¿ç”¨ ViewModel + LiveData. </p>
<blockquote>
<p>Loaders have been deprecated as of Android P (API 28). The recommended option for dealing with loading data while handling the Activity and Fragment lifecycles is to use a combination of ViewModels and LiveData. ViewModels survive configuration changes like Loaders but with less boilerplate. LiveData provides a lifecycle-aware way of loading data that you can reuse in multiple ViewModels.<br>If youâ€™ve never used loader before, congrats, time to go with architecture component directly!</p>
</blockquote>
<p>Serviceåœ¨åå°ä»»åŠ¡å¤„ç†ä¸­åˆæ‰®æ¼”äº†æ€æ ·çš„ä¸€ä¸ªè§’è‰²å‘¢ï¼ŸServiceè®¾è®¡ä¹‹åˆå°±æ˜¯ä¸ºäº†å¯ä»¥åœ¨åå°æ‰§è¡Œlong-running operations, ä¸€ä¸ªå¸¸è§çš„è¯¯è§£å°±æ˜¯Serviceå°±æ˜¯è¿è¡Œåœ¨background threadä¸Šçš„ï¼Œæˆ‘æƒ³å…¶ä¸­ä¸€å¤§åŸå› å°±æ˜¯æ¥è‡ªServiceçš„å®šä¹‰ï¼Œbackground + long-running operationså¾ˆå®¹æ˜“ç»™äººæœ‰é”™è¯¯çš„å‡å®šã€‚ </p>
<blockquote>
<p>A Service is an application component that can perform long-running operations in the background, and it doesnâ€™t provide a user interface.</p>
</blockquote>
<p>Serviceé»˜è®¤è¿è¡Œåœ¨å½“å‰åº”ç”¨è¿›ç¨‹çš„ä¸»çº¿ä¸­ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦æ‰§è¡Œblocking or intensive work (different from long-running operations)ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦è‡ªå·±åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚ä¸ºäº†æ–¹ä¾¿å¼€å‘ï¼ŒAndroidå®ç°äº†IntentServiceï¼Œå®ƒé€šè¿‡ä¸€ä¸ªåå°çº¿ç¨‹å»å¤„ç†æ‰€æœ‰çš„ä»»åŠ¡è¯·æ±‚ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä»»åŠ¡çš„å¤„ç†æ˜¯ä¸²è¡Œçš„ã€‚<br>é‚£ä¹ˆIntentServiceæˆ–æ˜¯é€šè¿‡Serviceå®ç°çš„å…¶å®ƒåå°ä»»åŠ¡å¤„ç†å’ŒAsyncTaskæˆ–æ˜¯Threadçš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>è™½ç„¶å®ƒä»¬æœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹Threadçš„å°è£…ï¼Œä½†æ˜¯å®ƒä»¬æœ‰å®Œå…¨ä¸åŒçš„è®¾è®¡åˆè¡·ã€‚å¯¹äºAsyncTaskè€Œè¨€ï¼Œæ›´å¤šçš„å’ŒActivity/UIå…³è”ï¼Œè€Œä¸”ä»»åŠ¡å¤„ç†é€šå¸¸æ˜¯è¦æ±‚å¾ˆçŸ­ï¼Œè€ŒServiceæ›´å¤šçš„æ˜¯åœ¨åº”ç”¨å¤„äºåå°ï¼ˆæ²¡æœ‰ç”¨æˆ·äº¤äº’æˆ–æ˜¯UIæ›´æ–°ï¼‰æ—¶å‘æŒ¥ä½œç”¨ï¼Œè€Œä¸”åœ¨ä»»åŠ¡æ²¡æœ‰å®Œæˆä¹‹å‰ï¼ŒServiceå¯ä»¥è¦æ±‚åœ¨ç³»ç»Ÿèµ„æºå……è¶³æ—¶é‡å¯ã€‚<br>JobIntentServiceåˆæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ è¿™äº›ç¼˜èµ·äºAndroidå¯¹åå°ä»»åŠ¡çš„é™åˆ¶å’Œä¼˜åŒ–ã€‚æˆ‘ä»¬ä¹‹ååœ¨åå°ä¸€ç›´è¿è¡ŒServiceå…¶å®å¾ˆåƒç³»ç»Ÿèµ„æºï¼Œç‰¹åˆ«æ˜¯æœ‰ä¸å°‘æ— è‰¯Appä¼šé€šè¿‡Serviceå¸¸é©»åå°ï¼Œç»™ç”¨æˆ·å¸¦æ¥äº†å¾ˆå·®çš„ç”¨æˆ·ä½“éªŒã€‚æ‰€ä»¥Android Nï¼ˆAndroid 7.0ï¼‰å’Œ Android Oï¼ˆAndroid 8.0ï¼‰ç³»ç»Ÿå¯¹Background Serviceå’ŒBroadcaståšäº†ä¸€å®šçš„é™åˆ¶ï¼Œå…¶ä¸­çš„ä¸€äº›é™åˆ¶åŒ…æ‹¬ï¼š<br>ä¸å¯ä»¥åœ¨åº”ç”¨å¤„äºåå°çŠ¶æ€æ—¶call startServiceå¯åŠ¨Serviceï¼ŒIllegalStateException will be thrown otherwise<br>å½“åº”ç”¨é€€åˆ°åå°ä¹‹åï¼Œç³»ç»Ÿä¼šç»™åº”ç”¨å‡ åˆ†é’Ÿå·¦å³çš„æ—¶é—´ç»§ç»­è¿è¡Œä¹‹å‰æ‰€åˆ›å»ºå¯åŠ¨çš„åå°æœåŠ¡ï¼Œä¹‹åä¾¿ä¼šè¢«ç³»ç»Ÿæ ‡è®°ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¹¶åœæ­¢è¯¥åå°æœåŠ¡ã€‚</p>
<p>Above limitations are only background service as foreground service is more visible to users.</p>
<p>å¯¹äºBroadcastçš„é™åˆ¶åŒ…æ‹¬ï¼š</p>
<ul>
<li>Android 7.0 ä¸­ï¼Œapp can NOT send or receive ACTION_NEW_PICTURE or ACTION_NEW_VIDEO broadcast</li>
<li>App targeting Android 7.0 and higher canâ€™t receive CONNECTIVITY_ACTION if itâ€™s declared in manifest</li>
<li>From Android Oï¼Œall implicit broadcast receivers declared in manifest file will not work</li>
</ul>
<p>è¿™ä¹ˆåšçš„åŸå› å¾ˆç®€å•ï¼Œå› ä¸ºimplicit broadcastæ˜¯ä¸€ä¸ªå¾ˆæµªè´¹ç³»ç»Ÿèµ„æºçš„äº‹æƒ…ã€‚æ¯”å¦‚æœ‰10ä¸ªåº”ç”¨æ³¨å†Œå¹¶ç›‘å¬äº†è¿™ä¸ªCONNECTIVITY_ACTIONè¿™ä¸ªå¹¿æ’­ï¼Œå½“ç”¨æˆ·æ‰‹æœºçš„ç½‘ç»œè¿æ¥å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™10ä¸ªåº”ç”¨éƒ½ä¼šè¢«å”¤èµ·å»å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œä½†å¯èƒ½å…¶ä¸­90%çš„åº”ç”¨åªå…³å¿ƒç”¨æˆ·æ˜¯å¦è¿æ¥åˆ°wifiä»¥ä¾¿åŒæ­¥æ•°æ®ï¼Œé‚£ä¹ˆå½“ç”¨æˆ·å¤±å»ç½‘ç»œè¿æ¥æˆ–æ˜¯è¿æ¥åˆ°metered networkæ—¶ï¼Œè¿™äº›åº”ç”¨éƒ½è¢«ä¸å¿…è¦çš„å”¤é†’äº†ã€‚<br>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¹¶ç»™å¼€å‘è€…æä¾›æ›´åŠ æ™ºèƒ½çš„åå°ä»»åŠ¡å¤„ç†ï¼ŒAndroidæå‡ºäº†Jobå’ŒJobSchedulerçš„æ¦‚å¿µï¼Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°†ä¼šæœ‰è¿›ä¸€æ­¥çš„äº†è§£ã€‚</p>
<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¤§è‡´è®²è§£äº†AsyncTask, Loader, IntentServiceçš„åŒºåˆ«ä»¥åŠAPIçš„æ¼”å˜å‘å±•ï¼Œä¸ºäº†ä¼˜åŒ–åå°ä»»åŠ¡ï¼Œç»™å¼€å‘è€…æä¾›æ›´åŠ æ–¹ä¾¿æ™ºèƒ½çš„ä»»åŠ¡å¤„ç†ï¼ŒAndroidåœ¨5.0 (API 21)ä¸­æ¨å‡ºäº†JobSchedulerã€‚<br>JobSchedulerçš„ä¸€å¤§ä¼˜ç‚¹å°±æ˜¯å®ƒæ˜¯åŸºäºæ¡ä»¶è€Œéæ—¶é—´è€Œè¿›è¡Œä»»åŠ¡å¤„ç†çš„ã€‚ [ref <a href="https://medium.com/google-developers/scheduling-jobs-like-a-pro-with-jobscheduler-286ef8510129]" target="_blank" rel="noopener">https://medium.com/google-developers/scheduling-jobs-like-a-pro-with-jobscheduler-286ef8510129]</a> (è¿™ç¯‡æ–‡ç« è®²çš„å¾ˆæ£’ï¼‰ã€‚<br>JobScheduler performs work based on conditions, not on time.<br>é€šè¿‡JobInfoæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“å¾—é…ç½®åå°ä»»åŠ¡æ‰€éœ€çš„å„ç§æ¡ä»¶ ï¼Œæ¯”å¦‚ç½‘ç»œç±»å‹ï¼Œç³»ç»Ÿæ˜¯å¦ç©ºé—²ï¼Œ æ˜¯å¦åœ¨å……ç”µç­‰ç­‰ï¼Œåœ¨Android 8.0 (API 26)ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®ç”µé‡å’Œå­˜å‚¨å®¹é‡çš„é™åˆ¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val jobScheduler = context.getSystemService(Context.JOB_SCHEDULER_SERVICE) as JobScheduler</span><br><span class="line">        jobScheduler.schedule(JobInfo.Builder(JOB_ID, ComponentName(context, CustomJobService::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line"><span class="class">            .<span class="title">setRequiredNetworkType</span>(<span class="title">JobInfo</span>.<span class="title">NETWORK_TYPE_UNMETERED</span>) // è¿æ¥<span class="title">wifi</span>æ—¶</span></span><br><span class="line"><span class="class">            .<span class="title">setRequiresDeviceIdle</span>(<span class="title">true</span>)    // éœ€è¦ç³»ç»Ÿç©ºé—²</span></span><br><span class="line"><span class="class">            .<span class="title">setRequiresCharging</span>(<span class="title">true</span>)      // è®¾å¤‡å……ç”µä¸­</span></span><br><span class="line"><span class="class">            .<span class="title">setRequiresBatteryNotLow</span>(<span class="title">true</span>) // <span class="title">requires</span> <span class="title">API</span> 26 ç”µé‡</span></span><br><span class="line"><span class="class">            .<span class="title">setRequiresStorageNotLow</span>(<span class="title">true</span>) // <span class="title">requires</span> <span class="title">API</span> 26 å­˜å‚¨å®¹é‡</span></span><br><span class="line"><span class="class">            .<span class="title">build</span>())</span></span><br></pre></td></tr></table></figure>
<p>JobSchduleré€šè¿‡åœ¨ç³»ç»Ÿçº§åˆ«å®ç°æ‰€æœ‰åº”ç”¨åå°ä»»åŠ¡çš„ç»Ÿä¸€è°ƒåº¦ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨é€šè¿‡AlarmManagerä¸æ–­å”¤èµ·åº”ç”¨å»æ£€æŸ¥å¹¶æ‰§è¡Œä»»åŠ¡äº†ï¼Œæå¤§ç¨‹åº¦ä¸Šç¼“è§£äº†ç”µé‡çš„æŸè€—ã€‚<br>æˆ‘ä»¬æ‰€éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡é€šè¿‡JobServiceæ¥å®ç°ï¼ŒJobServiceæ˜¯ä¸€ä¸ªbound serviceï¼Œåªä¸è¿‡å®ƒå®ç°åœ¨è‡ªå·±çš„IBinderä»¥ä¾¿JobSchedulerè¿›è¡Œé€šä¿¡ã€‚æˆ‘ä»¬åªéœ€è¦å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªæ–¹æ³•å›è°ƒä¸­å¼€å§‹ä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="comment"> * å’Œå…¶å®ƒServiceä¸€æ ·ï¼Œé»˜è®¤åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä»»ä½•å¯èƒ½é˜»å¡UIçš„æ“ä½œéƒ½åº”è¯¥é€šè¿‡worker threadå»æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params    å…³äºå½“å‰jobçš„ä¸€äº›ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true å¦‚æœå½“å‰jobè¿˜éœ€è¦æ‰§è¡Œä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚å¼€å¯äº†æ–°çš„çº¿ç¨‹ï¼‰, åä¹‹return false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> fun <span class="title">onStartJob</span><span class="params">(params: JobParameters)</span>: Boolean</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> * å› ä¸ºJobServiceæ˜¯åŸºäºæ¡ä»¶è°ƒåº¦çš„ï¼Œæ‰€ä»¥å½“æ‰€éœ€çš„æ¡ä»¶ä¸å†æ»¡è¶³æ—¶ï¼Œç³»ç»Ÿä¾¿ä¼šé€šè¿‡è¿™ä¸ªå›è°ƒé€šçŸ¥æˆ‘ä»¬ï¼Œæˆ‘ä»¬éœ€è¦</span></span></span><br><span class="line"><span class="function"><span class="comment"> * åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å¹¶å®Œæˆç›¸åº”çš„ä¸­æ–­å¤„ç†ã€‚</span></span></span><br><span class="line"><span class="function"><span class="comment"> *</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @param params    å…³äºå½“å‰jobçš„ä¸€äº›ä¿¡æ¯, æ¯”å¦‚job idï¼Œä»»åŠ¡åœæ­¢åŸå› ç­‰ç­‰</span></span></span><br><span class="line"><span class="function"><span class="comment"> * @return true å¦‚æœå½“å‰ä¸­æ–­çš„ä»»åŠ¡éœ€è¦è¢«é‡æ–°è°ƒåº¦ï¼Œåä¹‹return false</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> fun <span class="title">onStopJob</span><span class="params">(params: JobParameters)</span>: Boolean</span></span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥åœ¨Android L+ (5.0+ API 21+)åï¼Œæ‰€æœ‰å¤æ‚ï¼Œå‘¨æœŸæ€§çš„åå°ä»»åŠ¡æˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡JobScheduleræ¥å®ç°ä»¥è¾¾åˆ°æ›´å¥½çš„æ€§èƒ½ã€‚<br>WARNING - JobScheduleråœ¨API 21å’Œ22ä¸­æœ‰å¾ˆå¤šbugï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åœ¨productionä¸­ï¼Œæœ€å¥½åœ¨API 23+ä¹‹åæ‰ä½¿ç”¨JobSchedulerã€‚<br>è®²åˆ°è¿™ï¼Œå¦ä¸€ä¸ªæˆ‘ä»¬éœ€è¦äº†è§£çš„éƒ¨ä»¶å°±æ˜¯JobDispatcherï¼Œå®ƒçš„å­˜åœ¨å°±æ˜¯ä¸ºäº†å®ç°JobSchedulerçš„å‘åå…¼å®¹ (æœ€ä½æ”¯æŒ API 14)ã€‚JobDispatcheræ¥è‡ªäºFirebaseï¼Œå®ƒè®¾è®¡äº†å’ŒJobSchedulerç±»ä¼¼çš„APIï¼Œåœ¨Android L+çš„ç³»ç»Ÿä¸­ï¼Œåº•å±‚çš„å®ç°å°±æ˜¯JobSchedulerã€‚åœ¨Android Lä¹‹å‰çš„ç³»ç»Ÿä¸­ï¼Œå®ƒé€šè¿‡ä½¿ç”¨Google Play Serviceæ¥å……å½“ç»Ÿä¸€è°ƒåº¦è€…çš„è§’è‰²ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€éœ€è¦è®¾å¤‡å®‰è£…GMSæ‰å¯ä»¥ï¼Œå¯¹äºå›½å†…çš„ç”¨æˆ·æ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿå°±åªéœ€è¦äº†è§£ä¸€ä¸‹å°±å¥½äº†ï¼Œåä¹‹ä¹Ÿä¸å¤§ç”¨å¾—ä¸Š :(<br>WorkManager æ˜¯ä»Šå¹´IOæ¨å‡ºçš„æ–°çš„APIï¼Œæœ€ç®€å•çš„æ¦‚æ‹¬å°±æ˜¯å®ƒæ˜¯å¯¹æˆ‘ä»¬ä¹‹å‰æåˆ°çš„JobScheduler, JobDispatcher, AlarmManagerçš„å¦ä¸€å±‚å°è£…ï¼Œå®ƒä¼šæ ¹æ®ä¸åŒç³»ç»Ÿé€‰æ‹©åˆé€‚çš„å®ç°æ–¹å¼ã€‚å½“ç„¶å®ƒè¿˜ç»™æˆ‘ä»¬æä¾›ä¸€äº›å…¶å®ƒçš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ›´åŠ çµæ´»çš„ä»»åŠ¡è°ƒåº¦chain jobsï¼Œi.e. <code>WorkManager.getInstance().beginWith(A, B).then(C).then(D).enqueue()</code>ã€‚ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="meta">@NonNull</span> <span class="function">Scheduler <span class="title">createBestAvailableBackgroundScheduler</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">    Scheduler scheduler;</span><br><span class="line">    <span class="keyword">boolean</span> enableFirebaseJobService = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> enableSystemAlarmService = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= WorkManagerImpl.MIN_JOB_SCHEDULER_API_LEVEL) &#123;</span><br><span class="line">        scheduler = <span class="keyword">new</span> SystemJobScheduler(context);</span><br><span class="line">        setComponentEnabled(context, SystemJobService.class, <span class="keyword">true</span>);</span><br><span class="line">        Log.d(TAG, <span class="string">"Created SystemJobScheduler and enabled SystemJobService"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		scheduler = tryCreateFirebaseJobScheduler(context);</span><br><span class="line">            enableFirebaseJobService = <span class="keyword">true</span>;</span><br><span class="line">            Log.d(TAG, <span class="string">"Created FirebaseJobScheduler"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Also catches the exception thrown if Play Services was not found on the device.</span></span><br><span class="line">            scheduler = <span class="keyword">new</span> SystemAlarmScheduler(context);</span><br><span class="line">            enableSystemAlarmService = <span class="keyword">true</span>;</span><br><span class="line">            Log.d(TAG, <span class="string">"Created SystemAlarmScheduler"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class firebaseJobServiceClass = Class.forName(FIREBASE_JOB_SERVICE_CLASSNAME);</span><br><span class="line">        setComponentEnabled(context, firebaseJobServiceClass, enableFirebaseJobService);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// Do nothing.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setComponentEnabled(context, SystemAlarmService.class, enableSystemAlarmService);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scheduler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Scheduleræ˜¯ç”¨æ¥è°ƒåº¦å·¥ä½œçš„interfaceï¼Œä»ğŸ‘†çš„ä»£ç æ®µä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°WorkManageræ˜¯å¦‚æœæ ¹æ®ç³»ç»Ÿæ¡ä»¶åˆ›å»ºSchedulerçš„ï¼Œç®€æ˜“çš„å†³ç­–å›¾å¦‚ä¸‹</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯WorkManagerå’ŒServiceä¸€æ ·ï¼Œæ˜¯ç”¨æ¥å®ç°é‚£äº›å³ä¾¿åº”ç”¨è¢«æ€æ­»ä¹‹åä»éœ€å®Œæˆçš„ä»»åŠ¡ã€‚å¯¹äºé‚£äº›å‰å°çš„è€—æ—¶ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡AnsycTaskï¼ŒThreadPoolæ¥å®ç°ï¼Œè¯¦æƒ…å¯ä»¥é˜…è¯»å‰ä¸€ç¯‡æ–‡ç« ã€‚<br>å¸Œæœ›è¿™ä¸¤ç¯‡æ–‡ç« èƒ½å¤Ÿç»™å¤§å®¶å¯¹androidåå°ä»»åŠ¡çš„APIæ¼”å˜æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå¹¶å­¦ä¼šæ ¹æ®é¡¹ç›®è¦æ±‚é€‰æ‹©æœ€åˆé€‚çš„å®ç°ã€‚</p>
<p>happy coding </p>

  </section>
</article>

  <!-- <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="/images/avatar.jpeg" alt="avatar">
    <div class="grid-item">
      <p class="title"> Coffee Thoughts </p>
      <p class="subtitle"> Focusing & Drinking Coffee â˜• </p>
    <div>
  </div></div></section>

  <section class="share-btns">
    <a class="twitter-share-button" data-size="large" data-via="chuang_xie" href="https://twitter.com/intent/tweet?text=Evolving of android threading & background tasks">
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>
 -->

  <!-- 
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'chuang';
  
  var disqus_url = 'https://github.com/chuangx/2018/06/05/Development-of-background-tasks-in-android/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


   -->
</main>

</body>
</html>
